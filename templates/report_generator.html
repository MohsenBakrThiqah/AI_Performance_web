{% extends "base.html" %}

{% block title %}Report Generator{% endblock %}

{% block content %}
<div class="card fade-in" style="--delay: 0.2s">
    <div class="card-header bg-primary text-white">
        <h2>JMeter Report Generator</h2>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{{ url_for('report_generator') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.4s">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Workload Model</span>
                            </div>
                        </div>
                        <div id="workloadModel">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="project_name" class="form-label">Project Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="project_name" name="project_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="test_round" class="form-label">Test Round # <span class="text-danger">*</span></label>
                                    <select class="form-select" id="test_round" name="test_round" required>
                                        {% for i in range(1, 11) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="performance_test_type" class="form-label">Performance Test Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="performance_test_type" name="performance_test_type" required>
                                        <option value="Baseline">Baseline</option>
                                        <option value="Load">Load</option>
                                        <option value="Stress">Stress</option>
                                        <option value="Spike">Spike</option>
                                        <option value="Volume">Volume</option>
                                        <option value="Endurance">Endurance</option>
                                        <option value="Benchmark">Benchmark</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="cu" class="form-label">Number of CUs <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="cu" name="cu" required>
                                </div>
                                <div class="mb-3">
                                    <label for="ramp_up" class="form-label">Ramp Up in minutes <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="ramp_up" name="ramp_up" required>
                                </div>
                                <div class="mb-3">
                                    <label for="duration" class="form-label">Duration in minutes <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="duration" name="duration" required>
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">URL Under Test <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="url" name="url" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.6s">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Results</span>
                            </div>
                        </div>
                        <div id="resultsSection">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="engineer_name" class="form-label">Report Creator Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="engineer_name" name="engineer_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="round_status" class="form-label">Test Round Results <span class="text-danger">*</span></label>
                                    <select class="form-select" id="round_status" name="round_status" required>
                                        <option value="Compliant">Compliant</option>
                                        <option value="Not Compliant">Not Compliant</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="web_trans_status" class="form-label">Web Transactions Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="web_trans_status" name="web_trans_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="api_trans_status" class="form-label">API Transactions Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="api_trans_status" name="api_trans_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="error_rate_status" class="form-label">Error % Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="error_rate_status" name="error_rate_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="api_threshold" class="form-label">API 90% Threshold (ms) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="api_threshold" name="api_threshold" value="1000" required>
                                </div>
                                <div class="mb-3">
                                    <label for="err_rate_threshold" class="form-label">Error % Threshold <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="err_rate_threshold" name="err_rate_threshold" value="3" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.8s">
                        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#azureDetails">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Azure Details</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapse" id="azureDetails">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="new_bugs" class="form-label">Azure New Bugs IDs</label>
                                    <input type="text" class="form-control" id="new_bugs" name="new_bugs">
                                </div>
                                <div class="mb-3">
                                    <label for="reopened_bugs" class="form-label">Azure Reopened Bugs IDs</label>
                                    <input type="text" class="form-control" id="reopened_bugs" name="reopened_bugs">
                                </div>
                                <div class="mb-3">
                                    <label for="release_report" class="form-label">Azure Release Report</label>
                                    <input type="text" class="form-control" id="release_report" name="release_report">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 1s">
                        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#testScope">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Test Scope</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapse" id="testScope">
                            <div class="card-body">
                                <div class="mb-3">
                                    <textarea class="form-control" id="scope" name="scope" rows="5"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 fade-in" style="--delay: 1.2s">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#findings">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Findings</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </div>
                <div class="collapse" id="findings">
                    <div class="card-body">
                        <div class="mb-3">
                            <textarea class="form-control" id="findings_text" name="findings_text" rows="10" placeholder="Enter your findings here..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3 fade-in" style="--delay: 1.4s">
                <label for="report_folder" class="form-label">JMeter Report Folder (ZIP) <span class="text-danger">*</span></label>
                <input class="form-control" type="file" id="report_folder" name="report_folder" required>
            </div>

            <div class="mb-3 form-check fade-in" style="--delay: 1.6s">
                <input type="checkbox" class="form-check-input" id="use_gpt" name="use_gpt">
                <label class="form-check-label" for="use_gpt">Analyze results with OpenAI</label>
            </div>

            <div id="validationMessage" class="alert alert-danger d-none fade-in" style="--delay: 1.7s">
                Please fill in all mandatory fields marked with <span class="text-danger">*</span>
            </div>

            <button type="submit" class="btn btn-primary fade-in" style="--delay: 1.8s">Generate Report</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        opacity: 0;
        animation: fadeIn 0.6s ease-out forwards;
        animation-delay: var(--delay, 0s);
    }

    .card-header[role="button"] {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .card-header[role="button"]:hover {
        background-color: #0d6efd70;  /* Changed opacity from 40 to 70 */
    }

    .card-header .bi-chevron-down {
        transition: transform 0.3s;
    }

    .collapse.show + .card-body .bi-chevron-down {
        transform: rotate(180deg);
    }

    .invalid-field {
        border: 2px solid #dc3545 !important;
        background-color: #fff8f8;
    }

    .card-header.has-error {
        background-color: #dc35451a !important;
        color: #dc3545 !important;
        font-weight: bold;
    }

    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }

    .card-header.text-danger {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Reset previous validation states
            document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
            document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
            
            let isValid = true;
            let firstErrorSection = null;
            
            // Validate all required fields
            document.querySelectorAll('[required]').forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('invalid-field');
                    
                    // Find and expand the parent collapse section
                    const collapseSection = field.closest('.collapse');
                    if (collapseSection) {
                        // Store first error section for scrolling
                        if (!firstErrorSection) {
                            firstErrorSection = collapseSection;
                        }
                        
                        // Mark the header as having an error
                        const header = collapseSection.previousElementSibling;
                        if (header) {
                            header.classList.add('has-error');
                        }
                        
                        // Expand the section
                        bootstrap.Collapse.getOrCreateInstance(collapseSection).show();
                    }
                }
            });

            const validationMessage = document.getElementById('validationMessage');
            
            if (!isValid) {
                validationMessage.classList.remove('d-none');
                if (firstErrorSection) {
                    setTimeout(() => {
                        firstErrorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 200);
                }
            } else {
                validationMessage.classList.add('d-none');
                form.submit();
            }
        });

        // Clear validation styling on input
        document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('input', function() {
                this.classList.remove('invalid-field');
                
                // Check if all fields in section are valid
                const section = this.closest('.collapse');
                if (section) {
                    const allSectionFieldsValid = [...section.querySelectorAll('[required]')]
                        .every(f => f.value.trim());
                    
                    const header = section.previousElementSibling;
                    if (header && allSectionFieldsValid) {
                        header.classList.remove('has-error');
                    }
                }
            });
        });
    });
</script>
{% endblock %}