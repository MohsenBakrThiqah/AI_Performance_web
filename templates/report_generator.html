{% extends "base.html" %}

{% block title %}Report Generator{% endblock %}

{% block content %}
<div class="card fade-in" style="--delay: 0.2s">
    <div class="card-header bg-primary text-white">
        <h2>JMeter Report Generator</h2>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{{ url_for('report_generator') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.4s">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Project & Workload Model</span>
                            </div>
                        </div>
                        <div id="workloadModel">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="project_name" class="form-label">Project Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="project_name" name="project_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="test_round" class="form-label">Test Round # <span class="text-danger">*</span></label>
                                    <select class="form-select" id="test_round" name="test_round" required>
                                        {% for i in range(1, 11) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="performance_test_type" class="form-label">Performance Test Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="performance_test_type" name="performance_test_type" required>
                                        <option value="Baseline">Baseline</option>
                                        <option value="Load">Load</option>
                                        <option value="Stress">Stress</option>
                                        <option value="Spike">Spike</option>
                                        <option value="Volume">Volume</option>
                                        <option value="Endurance">Endurance</option>
                                        <option value="Benchmark">Benchmark</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="cu" class="form-label">Number of CUs <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="cu" name="cu" required>
                                </div>
                                <div class="mb-3">
                                    <label for="ramp_up" class="form-label">Ramp Up in minutes <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="ramp_up" name="ramp_up" required>
                                </div>
                                <div class="mb-3">
                                    <label for="duration" class="form-label">Duration in minutes <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="duration" name="duration" required>
                                </div>
                                <div class="mb-3">
                                    <label for="url" class="form-label">URL Under Test <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="url" name="url" required>
                                </div>
                                <div class="mb-3">
                                    <label for="APM_service_name" class="form-label">Elastic APM Service Name <span id="apm_required" class="text-danger d-none">*</span></label>
                                    <input type="text" class="form-control" id="APM_service_name" name="APM_service_name"  required>
                                    <small class="form-text text-muted">Must exactly matches Product service name on Kibana APM</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.6s">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Results</span>
                            </div>
                        </div>
                        <div id="resultsSection">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="engineer_name" class="form-label">Report Creator Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="engineer_name" name="engineer_name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="round_status" class="form-label">Test Round Results <span class="text-danger">*</span></label>
                                    <select class="form-select" id="round_status" name="round_status" required>
                                        <option value="Compliant">Compliant</option>
                                        <option value="Not Compliant">Not Compliant</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="web_trans_status" class="form-label">Web Transactions Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="web_trans_status" name="web_trans_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="api_trans_status" class="form-label">API Transactions Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="api_trans_status" name="api_trans_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="error_rate_status" class="form-label">Error % Compliant? <span class="text-danger">*</span></label>
                                    <select class="form-select" id="error_rate_status" name="error_rate_status" required>
                                        <option value="Y">Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="api_threshold" class="form-label">API 90% Threshold (ms) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="api_threshold" name="api_threshold" value="1000" required>
                                </div>
                                <div class="mb-3">
                                    <label for="err_rate_threshold" class="form-label">Error % Threshold <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="err_rate_threshold" name="err_rate_threshold" value="3" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 0.8s">
                        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#azureDetails">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Azure Details</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapse" id="azureDetails">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="new_bugs" class="form-label">Azure New Bugs IDs</label>
                                    <input type="text" class="form-control" id="new_bugs" name="new_bugs">
                                </div>
                                <div class="mb-3">
                                    <label for="reopened_bugs" class="form-label">Azure Reopened Bugs IDs</label>
                                    <input type="text" class="form-control" id="reopened_bugs" name="reopened_bugs">
                                </div>
                                <div class="mb-3">
                                    <label for="release_report" class="form-label">Azure Release Report</label>
                                    <input type="text" class="form-control" id="release_report" name="release_report">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3 fade-in" style="--delay: 1s">
                        <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#testScope">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Test Scope</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                        </div>
                        <div class="collapse" id="testScope">
                            <div class="card-body">
                                <div class="mb-3">
                                    <textarea class="form-control" id="scope" name="scope" rows="5"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 fade-in" style="--delay: 1.2s">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#findings">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Findings</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </div>
                <div class="collapse" id="findings">
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="formatting-help mb-2">
                                <small class="text-muted">
                                    Formatting: <strong>**bold and Colored**</strong>, 
                                    <code>1. Numbered list</code>, 
                                    <code>* Bullet point</code>, 
                                    <code>- Bullet point</code>
                                </small>
                            </div>
                            <textarea class="form-control" id="findings_text" name="findings_text" rows="10" 
                                placeholder="Enter your findings here...
Examples:
**Response time:**
    1. High response time in login API
    2. Dashboard page load is slow

**Errors:**
    * Connection timeout in payment process
    * Database locks in high concurrency"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chaos Experiments Section -->
            <div class="card mb-3 fade-in" style="--delay: 1.25s">
                <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#chaosExperimentsWrapper">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Chaos Experiments</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                </div>
                <div class="collapse" id="chaosExperimentsWrapper">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="chaos_experiments_count" class="form-label">Number of Experiments</label>
                            <div class="input-group">
                                <select class="form-select" id="chaos_experiments_count" name="chaos_experiments_count">
                                    {% for i in range(0,21) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="generateChaosBtn" title="Generate experiment fields">Generate</button>
                            </div>
                            <small class="text-muted">Select a number then click Generate to add experiment details.</small>
                        </div>
                        <div id="chaosExperimentsContainer" class="d-none"></div>
                    </div>
                </div>
            </div>

            <div class="mb-3 fade-in" style="--delay: 1.4s">
                <label for="report_folder" class="form-label">JMeter Report Folder (ZIP) <span class="text-danger">*</span></label>
                <input class="form-control" type="file" id="report_folder" name="report_folder" required>
            </div>

            <div class="mb-3 form-check fade-in" style="--delay: 1.6s">
                <input type="checkbox" class="form-check-input" id="use_gpt" name="use_gpt">
                <label class="form-check-label" for="use_gpt">Analyze results with OpenAI</label>
            </div>

            <div class="mb-3 form-check fade-in" style="--delay: 1.65s">
                <input type="checkbox" class="form-check-input" id="use_kibana_analysis" name="use_kibana_analysis">
                <label class="form-check-label" for="use_kibana_analysis">Analyze Kibana CPU & Memory Metrics With OpenAI</label>
            </div>

            <div id="validationMessage" class="alert alert-danger d-none fade-in" style="--delay: 1.7s">
                Please fill in all mandatory fields marked with <span class="text-danger">*</span>
            </div>

            <button type="submit" class="btn btn-primary fade-in" style="--delay: 1.8s">Generate Report</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        opacity: 0;
        animation: fadeIn 0.6s ease-out forwards;
        animation-delay: var(--delay, 0s);
    }

    .card-header[role="button"] {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .card-header[role="button"]:hover {
        background-color: #0d6efd70;  /* Changed opacity from 40 to 70 */
    }

    .card-header .bi-chevron-down {
        transition: transform 0.3s;
    }

    .collapse.show + .card-body .bi-chevron-down {
        transform: rotate(180deg);
    }

    .invalid-field {
        border: 2px solid #dc3545 !important;
        background-color: #fff8f8;
    }

    .card-header.has-error {
        background-color: #dc35451a !important;
        color: #dc3545 !important;
        font-weight: bold;
    }

    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }

    .card-header.text-danger {
        color: #dc3545;
    }

    .chaos-exp-card {
        border: 1px solid #e9ecef;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        background: #fafafa;
    }

    .chaos-exp-card h5 {
        font-size: 1rem;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const kibanaAnalysisCheckbox = document.getElementById('use_kibana_analysis');
        const apmServiceNameField = document.getElementById('APM_service_name');
        const apmRequiredLabel = document.getElementById('apm_required');
        // Chaos experiments generation handled in global scripts.js now
        // Removed previous change listener logic
        // Handle the conditional required state for APM service name
        if(kibanaAnalysisCheckbox){
            kibanaAnalysisCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    apmServiceNameField.setAttribute('required', '');
                    apmRequiredLabel.classList.remove('d-none');
                } else {
                    apmServiceNameField.removeAttribute('required');
                    apmRequiredLabel.classList.add('d-none');
                }
            });
        }
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
            document.querySelectorAll('.has-error').forEach(el => el.classList.remove('has-error'));
            let isValid = true; let firstErrorSection = null;
            document.querySelectorAll('[required]').forEach(field => {
                if (!field.value.trim()) {
                    isValid = false; field.classList.add('invalid-field');
                    const collapseSection = field.closest('.collapse');
                    if (collapseSection) {
                        if (!firstErrorSection) firstErrorSection = collapseSection;
                        const header = collapseSection.previousElementSibling; if (header) header.classList.add('has-error');
                        bootstrap.Collapse.getOrCreateInstance(collapseSection).show();
                    }
                }
            });
            const validationMessage = document.getElementById('validationMessage');
            if (!isValid) {
                validationMessage.classList.remove('d-none');
                if (firstErrorSection) setTimeout(()=>firstErrorSection.scrollIntoView({behavior:'smooth', block:'start'}),200);
            } else {
                validationMessage.classList.add('d-none');
                form.submit();
            }
        });
        document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('input', function() {
                this.classList.remove('invalid-field');
                const section = this.closest('.collapse');
                if (section) {
                    const allValid = [...section.querySelectorAll('[required]')].every(f=>f.value.trim());
                    const header = section.previousElementSibling; if (header && allValid) header.classList.remove('has-error');
                }
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function() {
        // Fallback (in case global scripts.js failed before attaching listener)
        const select = document.getElementById('chaos_experiments_count');
        const container = document.getElementById('chaosExperimentsContainer');
        const btn = document.getElementById('generateChaosBtn');
        function buildExperiment(i){
            return `\n<div class=\"chaos-exp-card\">\n  <h5>Experiment #${i}</h5>\n  <div class=\"mb-3\">\n    <label class=\"form-label\" for=\"chaos_experiment_${i}_title\">Title <span class=\"text-danger\">*</span></label>\n    <input type=\"text\" class=\"form-control\" id=\"chaos_experiment_${i}_title\" name=\"chaos_experiment_${i}_title\" required />\n  </div>\n  <div class=\"mb-3\">\n    <label class=\"form-label\" for=\"chaos_experiment_${i}_status\">Status <span class=\"text-danger\">*</span></label>\n    <select class=\"form-select\" id=\"chaos_experiment_${i}_status\" name=\"chaos_experiment_${i}_status\" required>\n      <option value=\"\">Select...</option>\n      <option value=\"Passed\">Passed</option>\n      <option value=\"Partially Passed\">Partially Passed</option>\n      <option value=\"Failed\">Failed</option>\n    </select>\n  </div>\n  <div class=\"mb-3\">\n    <label class=\"form-label\" for=\"chaos_experiment_${i}_description\">Description <span class=\"text-danger\">*</span></label>\n    <textarea class=\"form-control\" rows=\"4\" id=\"chaos_experiment_${i}_description\" name=\"chaos_experiment_${i}_description\" required></textarea>\n  </div>\n</div>`;
        }
        function renderChaos(){
            if(!select || !container) return;
            const count = parseInt(select.value||'0',10);
            container.innerHTML='';
            if(count>0){
                container.classList.remove('d-none');
                for(let i=1;i<=count;i++) container.insertAdjacentHTML('beforeend', buildExperiment(i));
                const collapseEl = document.getElementById('chaosExperimentsWrapper');
                if(collapseEl){ bootstrap.Collapse.getOrCreateInstance(collapseEl,{toggle:false}).show(); }
            } else {
                container.classList.add('d-none');
            }
        }
        if(btn && !btn.dataset.listenerAttached){
            btn.addEventListener('click', renderChaos);
            btn.dataset.listenerAttached = '1';
        }
    });
</script>
{% endblock %}
``` 