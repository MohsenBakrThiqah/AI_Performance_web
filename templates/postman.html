{% extends "base.html" %}

{% block title %}Postman Collection Tools{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm mb-5">
                <div class="card-header bg-info text-white">
                    <h2 class="mb-0">Postman Collection Tools</h2>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="postmanTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="analyze-tab" data-bs-toggle="tab"
                                    data-bs-target="#analyze" type="button" role="tab">
                                <i class="bi bi-magic"></i>  Postman to JMX with Claude AI
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="convert-tab" data-bs-toggle="tab"
                                    data-bs-target="#convert" type="button" role="tab">
                                <i class="bi bi-file-earmark-arrow-down"></i> Convert to JMX
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="postmanTabContent">
                        <!-- Analyze Tab -->
                        <div class="tab-pane fade show active" id="analyze" role="tabpanel">
                            <form method="post" enctype="multipart/form-data" action="{{ url_for('postman_tools') }}" id="analyzeForm">
                                <input type="hidden" name="action" value="analyze">

                                <div class="mb-4">
                                    <h4 class="mb-3">Generate JMX with Claude AI</h4>
                                    <p class="text-muted">
                                        Upload your Postman collection JSON to analyze it first, then generate an optimized JMX file using Claude AI.
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label for="postman_file" class="form-label">Postman Collection File</label>
                                    <input class="form-control" type="file" id="postman_file" name="postman_file"
                                           accept=".json" required>
                                    <div class="form-text">
                                        Export your collection from Postman as a v2.1 JSON file
                                    </div>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="submit" class="btn btn-info me-md-2">
                                        <i class="bi bi-search"></i> Analyze Collection
                                    </button>
                                    <button type="button" id="claudeButton" class="btn btn-success"
                                            {% if not (show_analysis and analysis) %}disabled{% endif %}>
                                        <i class="bi bi-robot"></i> Generate with Claude AI
                                    </button>
<!--                                    <button type="button" id="openaiButton" class="btn btn-primary"-->
<!--                                            {% if not (show_analysis and analysis) %}disabled{% endif %}>-->
<!--                                        <i class="bi bi-robot"></i> Generate with OpenAI-->
<!--                                    </button>-->
                                </div>
                            </form>

                            <div id="analysisResultsContainer">
                                {% if show_analysis and analysis %}
                                <div class="mt-5 fade-in">
                                    <h4 class="mb-4">Analysis Results</h4>
                                    <div class="alert alert-info">
                                        Found {{ analysis.requests|length }} request{% if analysis.requests|length != 1 %}s{% endif %}
                                        in collection "{{ analysis.collection_name }}"
                                    </div>

                                    <div class="accordion" id="analysisAccordion">
                                        {% for request in analysis.requests %}
                                        <div class="accordion-item mb-3">
                                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapse{{ loop.index }}"
                                                        aria-expanded="{{ 'true' if loop.first else 'false' }}">
                                                        <span class="badge
                                                            {% if request.method == 'GET' %}bg-primary
                                                            {% elif request.method == 'POST' %}bg-success
                                                            {% elif request.method == 'PUT' %}bg-warning text-dark
                                                            {% elif request.method == 'DELETE' %}bg-danger
                                                            {% elif request.method == 'OPTIONS' %}bg-warning
                                                            {% elif request.method == 'BATCH' %}bg-dark
                                                            {% else %}bg-secondary
                                                            {% endif %} me-2">
                                                            {{ request.method }}
                                                        </span>
                                                    {{ request.request }}
                                                </button>
                                            </h2>
                                            <div id="collapse{{ loop.index }}"
                                                 class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                                                 aria-labelledby="heading{{ loop.index }}"
                                                 data-bs-parent="#analysisAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-2">
                                                        <strong>URL:</strong>
                                                        <a href="{{ request.url }}" target="_blank" class="url-display">{{ request.url }}</a>
                                                    </div>

                                                    {% if request.parameters %}
                                                        <h5 class="mt-3">Parameters</h5>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Parameter</th>
                                                                        <th>Type</th>
                                                                        <th>Value</th>
                                                                        <th>Source</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {% for param in request.parameters %}
                                                                    <tr>
                                                                        <td><code>{{ param.param }}</code></td>
                                                                        <td>
                                                                            {% if param.correlate %}
                                                                                <span class="badge bg-success">Correlated</span>
                                                                            {% else %}
                                                                                <span class="badge bg-secondary">Static</span>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td class="text-truncate" style="max-width: 150px;">
                                                                            {{ param.value }}
                                                                        </td>
                                                                        <td>
                                                                            {% if param.correlate %}
                                                                                {{ param.source }}
                                                                                <div class="mt-1">
                                                                                    <small class="text-muted">JSONPath:</small>
                                                                                    <code class="d-block">{{ param.jsonpath }}</code>
                                                                                </div>
                                                                            {% else %}
                                                                                N/A
                                                                            {% endif %}
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    {% else %}
                                                        <div class="alert alert-light">
                                                            No parameters found in this request
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    <div class="card mt-4 border-info">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="mb-0">How to implement these correlations</h5>
                                        </div>
                                        <div class="card-body">
                                            <ol class="mb-3">
                                                <li>For each correlated parameter, add a JSON Extractor in JMeter</li>
                                                <li>Use the provided JSONPath expression to extract the value</li>
                                                <li>Reference the extracted value in subsequent requests using <code>${variable_name}</code></li>
                                            </ol>
                                            <div class="alert alert-warning mb-0">
                                                <i class="bi bi-exclamation-triangle"></i> Always verify correlations by running
                                                your test plan with 1 user first.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Convert Tab -->
                        <div class="tab-pane fade" id="convert" role="tabpanel">
                            <form method="post" enctype="multipart/form-data" action="{{ url_for('postman_tools') }}">
                                <input type="hidden" name="action" value="convert">

                                <div class="mb-4">
                                    <h4 class="mb-3">Convert to JMeter JMX</h4>
                                    <p class="text-muted">
                                        Convert your Postman collection directly to a JMeter test plan (JMX file).
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <label for="postman_file_convert" class="form-label">Postman Collection File</label>
                                    <input class="form-control" type="file" id="postman_file_convert"
                                           name="postman_file" accept=".json" required>
                                    <div class="form-text">
                                        Export your collection from Postman as a v2.1 JSON file
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enable_gpt" name="enable_gpt" disabled>
                                        <label class="form-check-label" for="enable_gpt">
                                            Use GPT-4o to enhance conversion - (Under Development)
                                        </label>
                                        <div class="form-text">
                                            Uses OpenAI to generate more accurate JMX
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-file-earmark-arrow-down"></i> Convert to JMX
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Postman Collection Tips</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="bi bi-check-circle text-success"></i> Do</h5>
                            <ul class="list-group list-group-flush mb-4">
                                <li class="list-group-item">
                                    <i class="bi bi-check text-success"></i> Export as Collection v2.1
                                </li>
                                <li class="list-group-item">
                                    <i class="bi bi-check text-success"></i> Include example responses
                                </li>
                                <li class="list-group-item">
                                    <i class="bi bi-check text-success"></i> Use environment variables for dynamic values
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="bi bi-x-circle text-danger"></i> Don't</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <i class="bi bi-x text-danger"></i> Use the legacy v1.0 format
                                </li>
                                <li class="list-group-item">
                                    <i class="bi bi-x text-danger"></i> Include binary file uploads
                                </li>
                                <li class="list-group-item">
                                    <i class="bi bi-x text-danger"></i> Use scripts that require Postman Sandbox
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingModalTitle">Generating JMX with AI</h5>
                <p class="mb-0">Please wait while we create your optimized test plan...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .accordion-button:not(.collapsed) {
        background-color: rgba(13, 110, 253, 0.05);
        color: #0d6efd;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #495057;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        border-bottom-color: #0dcaf0;
        color: #0dcaf0;
        background-color: transparent;
    }

    .nav-tabs .nav-link:hover:not(.active) {
        border-bottom-color: #dee2e6;
    }

    #claudeButton:disabled, #openaiButton:disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }

    #analysisResultsContainer {
        min-height: 50px;
        position: relative;
    }

    #analysisResultsContainer .fade-in {
        opacity: 1 !important;
        visibility: visible !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Tab persistence
    const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabEls.forEach(tabEl => {
        tabEl.addEventListener('click', function() {
            localStorage.setItem('activeTab', this.getAttribute('data-bs-target'));
        });
    });

    const activeTab = localStorage.getItem('activeTab');
    if (activeTab) {
        const tab = new bootstrap.Tab(document.querySelector(`[data-bs-target="${activeTab}"]`));
        tab.show();
    }

    // Postman Analysis Specific Functionality
    const analyzeForm = document.getElementById('analyzeForm');
    const claudeButton = document.getElementById('claudeButton');
    const openaiButton = document.getElementById('openaiButton');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const loadingModalTitle = document.getElementById('loadingModalTitle');

    // Enable AI buttons if analysis results are shown
    if (document.querySelector('#analysisAccordion')) {
        if (claudeButton) claudeButton.disabled = false;
        if (openaiButton) openaiButton.disabled = false;
    }

    // Handle Claude button click
    if (claudeButton) {
        claudeButton.addEventListener('click', function() {
            const fileInput = analyzeForm.querySelector('input[type="file"]');
            if (!fileInput || !fileInput.files.length) {
                alert('Please analyze a Postman collection first');
                return;
            }

            // Show loading modal with Claude-specific text
            loadingModalTitle.textContent = "Generating JMX with Claude AI";
            loadingModal.show();

            // Create FormData with the analyzed file
            const formData = new FormData();
            formData.append('postman_file', fileInput.files[0]);

            // Make AJAX request to generate JMX with Claude
            fetch('/generate_jmx_with_claude', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `claude_${fileInput.files[0].name.replace('.json', '.jmx')}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.error || 'Failed to generate JMX file');
            })
            .finally(() => {
                loadingModal.hide();
            });
        });
    }
    
    // Handle OpenAI button click
    if (openaiButton) {
        openaiButton.addEventListener('click', function() {
            const fileInput = analyzeForm.querySelector('input[type="file"]');
            if (!fileInput || !fileInput.files.length) {
                alert('Please analyze a Postman collection first');
                return;
            }

            // Show loading modal with OpenAI-specific text
            loadingModalTitle.textContent = "Generating JMX with OpenAI";
            loadingModal.show();

            // Create FormData with the analyzed file
            const formData = new FormData();
            formData.append('postman_file', fileInput.files[0]);

            // Make AJAX request to generate JMX with OpenAI using the correct endpoint
            fetch('/generate_jmx_with_openai', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `openai_${fileInput.files[0].name.replace('.json', '.jmx')}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.error || 'Failed to generate JMX file');
            })
            .finally(() => {
                loadingModal.hide();
            });
        });
    }

    // Modified form submission handling
    if (analyzeForm) {
        analyzeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitButton = analyzeForm.querySelector('button[type="submit"]');
            const resultsContainer = document.getElementById('analysisResultsContainer');
            
            submitButton.disabled = true;
            
            fetch("{{ url_for('postman_tools') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newAnalysis = doc.querySelector('.fade-in');
                
                if (newAnalysis) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.appendChild(newAnalysis);
                    
                    // Force a reflow to trigger animation
                    void resultsContainer.offsetWidth;
                    newAnalysis.style.opacity = '1';
                    
                    // Enable AI buttons
                    if (claudeButton) claudeButton.disabled = false;
                    if (openaiButton) openaiButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to analyze the collection. Please try again.');
            })
            .finally(() => {
                submitButton.disabled = false;
            });
        });
    }

    // Auto-format URLs in correlation results
    document.querySelectorAll('.url-display').forEach(el => {
        const url = el.textContent.trim();
        if (url) {
            el.innerHTML = '';
            const a = document.createElement('a');
            a.href = url;
            a.textContent = url;
            a.target = '_blank';
            el.appendChild(a);
        }
    });

    // Responsive table handling
    document.querySelectorAll('.table-responsive').forEach(tableWrapper => {
        tableWrapper.addEventListener('mouseenter', function() {
            this.style.overflowX = 'auto';
        });
        tableWrapper.addEventListener('mouseleave', function() {
            this.style.overflowX = 'hidden';
        });
    });
});
</script>
{% endblock %}